import type { RegionSlug } from '@/types/product';
// @ts-ignore - JSON import
import faqTopics from '../SEO_research/faq_topics.json';
// @ts-ignore - JSON import
import highFreqLowComp from '../SEO_research/high_freq_low_comp.json';

interface FAQTopic {
  frequency: number;
  query: string;
  cluster: string;
}

interface FAQQuestion {
  q: string;
  a: string;
}

/**
 * Преобразует сырой поисковый запрос в нормальный вопрос на русском языке
 */
function normalizeQueryToQuestion(query: string): string {
  const lower = query.toLowerCase().trim();
  
  // Маппинг сырых запросов на нормальные вопросы
  const questionMap: Record<string, string> = {
    'сколько газоблок': 'Сколько нужно газоблоков для строительства дома?',
    'сколько газобетона': 'Сколько нужно газобетона для строительства дома?',
    'какой газобетон': 'Какой газобетон выбрать для строительства?',
    'газоблоки какие': 'Какие газоблоки нужны для строительства?',
    'нужен газоблок': 'Какие газоблоки нужны для строительства дома?',
    'нужен газобетон': 'Какой газобетон нужен для строительства дома?',
    'стоит газобетон': 'Сколько стоит газобетон за куб?',
    'чем хорош газобетон': 'Чем хорош газобетон для строительства?',
    'какой газобетон лучше': 'Какой газобетон лучше выбрать?',
    'сколько блоков газобетон': 'Сколько блоков газобетона нужно на дом?',
    'расчет газобетона': 'Как рассчитать количество газобетона на дом?',
    'сколько кубов газобетона': 'Сколько кубов газобетона нужно на дом?',
    'газобетон сколько нужно': 'Сколько газобетона нужно на дом?',
    'сколько газобетона в кубе': 'Сколько блоков газобетона в кубе?',
    'газоблок сколько нужно': 'Сколько газоблоков нужно на дом?',
    'газоблок сколько штук': 'Сколько штук газоблоков нужно на дом?',
    'сколько газобетонных блоков': 'Сколько газобетонных блоков нужно на дом?',
    'сколько кубов в газоблоке': 'Сколько блоков газобетона в кубе?',
    'сколько куб газоблока в кубе': 'Сколько блоков газобетона в кубе?',
    'сколько газоблоков в кубе': 'Сколько газоблоков в кубе?',
    'газобетон производители': 'Какие производители газобетона лучше?',
    'производители газобетона в спб': 'Какие производители газобетона работают в СПб?',
    'минусы газобетона': 'Какие минусы у газобетона?',
    'минусы газоблока': 'Какие минусы у газоблока?',
    'газоблок плюсы': 'Какие плюсы у газоблока?',
    'газоблок плюсы и минусы': 'Какие плюсы и минусы у газоблока?',
    'пеноблок или газоблок': 'Пеноблок или газоблок — что лучше?',
    'сколько газоблоков на дом': 'Сколько газоблоков нужно на дом?',
    'газобетон фундамент какой': 'Какой фундамент нужен для газобетона?',
    'газобетон разница': 'Чем газобетон отличается от других материалов?',
    'как сделать газобетон': 'Как производят газобетон?',
    'газобетон плюсы': 'Какие плюсы у газобетона?',
    'плиты из газобетона': 'Можно ли использовать газобетон для перекрытий?',
    'монолитный газобетон': 'Что такое монолитный газобетон?',
  };

  // Если есть точное совпадение, возвращаем нормализованный вопрос
  if (questionMap[lower]) {
    return questionMap[lower];
  }

  // Если запрос начинается с "сколько", добавляем "нужно" или "стоит"
  if (lower.startsWith('сколько')) {
    if (lower.includes('стоит') || lower.includes('цена') || lower.includes('стоимость')) {
      return `Сколько стоит ${lower.replace(/сколько\s*(стоит|цена|стоимость)?\s*/g, '').trim()}?`;
    }
    if (lower.includes('куб') || lower.includes('кубов')) {
      return `Сколько кубов ${lower.replace(/сколько\s*(куб|кубов)?\s*/g, '').trim()} нужно на дом?`;
    }
    return `Сколько нужно ${lower.replace(/сколько\s*/g, '').trim()}?`;
  }

  // Если запрос начинается с "какой", добавляем "выбрать"
  if (lower.startsWith('какой')) {
    return `${lower.charAt(0).toUpperCase() + lower.slice(1)} выбрать?`;
  }

  // Если запрос начинается с "какие", добавляем "нужны"
  if (lower.startsWith('какие')) {
    return `${lower.charAt(0).toUpperCase() + lower.slice(1)} нужны для строительства?`;
  }

  // Если запрос начинается с "нужен" или "нужны", переформулируем
  if (lower.startsWith('нужен') || lower.startsWith('нужны')) {
    return `Какие ${lower.replace(/нужен(а|ы)?\s*/g, '').trim()} нужны для строительства?`;
  }

  // Если запрос начинается с "стоит", добавляем "сколько"
  if (lower.startsWith('стоит')) {
    return `Сколько стоит ${lower.replace(/стоит\s*/g, '').trim()}?`;
  }

  // По умолчанию: добавляем заглавную букву и знак вопроса
  return query.charAt(0).toUpperCase() + query.slice(1) + '?';
}

// Маппинг вопросов из faq_topics.json на готовые ответы
const FAQ_ANSWERS: Record<string, string> = {
  'сколько газоблок': 'Количество газоблоков зависит от размера проекта. Для дома 10×10 м (100 м²) с толщиной стен 300 мм нужно примерно 30–35 м³, что составляет около 650–750 блоков размером 625×300×250 мм. Используйте наш калькулятор для точного расчёта под ваш проект.',
  'сколько газобетона': 'Объём газобетона зависит от площади и толщины стен. Для дома 100 м² с толщиной 300 мм нужно примерно 30–35 м³. Для бани 24 м² — 6–8 м³. В каталоге указаны цены за м³ для каждого региона. Используйте калькулятор или пришлите проект — рассчитаем точно.',
  'какой газобетон': 'Выбор зависит от задачи: для энергоэффективных домов — D400 толщиной 300–400 мм, для универсального строительства — D500 толщиной 300–375 мм. По брендам: Bonolit и Ytong — эталон качества, ЛСР — для северо-запада, региональные заводы — выгодная цена. Используйте квиз подбора для персональной рекомендации.',
  'газоблоки какие': 'Газоблоки различаются по плотности (D300–D700), толщине (100–400 мм) и назначению. Для наружных стен — D400–D500 толщиной 300–400 мм, для перегородок — D400–D500 толщиной 100–150 мм. В каталоге каждый товар помечен назначением и характеристиками.',
  'нужен газоблок': 'Для наружных стен нужны блоки D400–D500 толщиной 300–400 мм, для внутренних несущих стен — D500 толщиной 200–250 мм, для перегородок — D400–D500 толщиной 100–150 мм. Количество рассчитывается через калькулятор. В каталоге каждый товар помечен назначением.',
  'нужен газобетон': 'Для наружных стен нужны блоки D400–D500 толщиной 300–400 мм, для внутренних несущих стен — D500 толщиной 200–250 мм, для перегородок — D400–D500 толщиной 100–150 мм. Количество рассчитывается через калькулятор или по проекту.',
  'стоит газобетон': 'Цена зависит от бренда, плотности, размера и региона. В каталоге указаны актуальные цены за м³ для каждого региона. Например, блоки D500 толщиной 300 мм стоят от 4500 до 6500 руб/м³. При заказе от 20 м³ — бесплатная доставка, для крупных объектов — оптовые скидки.',
  'чем хорош газобетон': 'Газобетон сочетает лёгкость (в 3–4 раза легче кирпича), отличную теплоизоляцию (не требует утепления при правильной толщине), точную геометрию (±1–2 мм), пожаробезопасность, экологичность и скорость кладки. Это оптимальный материал для частного строительства.',
  'какой газобетон лучше': 'Лучший выбор зависит от задачи: для энергоэффективных домов — D400 толщиной 300–400 мм, для универсального строительства — D500 толщиной 300–375 мм. По брендам: Bonolit и Ytong — эталон качества, ЛСР — для северо-запада, региональные заводы — выгодная цена.',
  'сколько блоков газобетон': 'Количество блоков зависит от размера проекта. Для дома 10×10 м (100 м²) с толщиной стен 300 мм нужно примерно 650–750 блоков размером 625×300×250 мм (30–35 м³). Используйте калькулятор для точного расчёта под ваш проект.',
  'расчет газобетона': 'Для расчёта используйте наш калькулятор: укажите периметр, высоту, толщину блоков, окна и двери — получите объём с запасом 5–7%. Или пришлите проект — инженер рассчитает вручную с учётом всех нюансов и подготовит КП.',
  'сколько кубов газобетона': 'Объём зависит от площади и толщины стен. Для дома 100 м² с толщиной 300 мм нужно примерно 30–35 м³. Для бани 24 м² — 6–8 м³. Используйте калькулятор или пришлите проект — рассчитаем точно с учётом всех особенностей.',
  'газобетон сколько нужно': 'Количество зависит от площади, этажности и толщины стен. Для дома 10×10 м (100 м²) с толщиной стен 300 мм нужно примерно 30–35 м³ газобетона. Используйте калькулятор для точного расчёта или пришлите проект.',
  'сколько газобетона в кубе': 'Вопрос некорректен — газобетон измеряется в кубометрах (м³), а не в кубах. Правильный вопрос: «Сколько блоков в кубе?» Количество блоков в м³ зависит от размера: блок 625×300×250 мм — 21 шт/м³, блок 600×300×250 мм — 22 шт/м³.',
  'газоблок сколько нужно': 'Для наружных стен нужны блоки D400–D500 толщиной 300–400 мм. Количество рассчитывается через калькулятор: укажите периметр, высоту, толщину блоков — получите объём с запасом 5–7%. Или пришлите проект — рассчитаем точно.',
  'газоблок сколько штук': 'Количество штук зависит от размера блока и объёма проекта. Например, для дома 100 м² с толщиной стен 300 мм нужно примерно 650–750 блоков размером 625×300×250 мм (30–35 м³). Используйте калькулятор для точного расчёта.',
  'сколько газобетонных блоков': 'Количество блоков зависит от размера проекта. Для дома 10×10 м (100 м²) с толщиной стен 300 мм нужно примерно 650–750 блоков размером 625×300×250 мм (30–35 м³). Используйте калькулятор для точного расчёта под ваш проект.',
  'сколько кубов в газоблоке': 'Вопрос некорректен — газоблок измеряется в кубометрах (м³), а не в кубах. Правильный вопрос: «Сколько блоков в кубе?» Количество блоков в м³ зависит от размера: блок 625×300×250 мм — 21 шт/м³, блок 600×300×250 мм — 22 шт/м³.',
  'сколько куб газоблока в кубе': 'Вопрос некорректен — газоблок измеряется в кубометрах (м³). Правильный вопрос: «Сколько блоков в кубе?» Количество блоков в м³ зависит от размера: блок 625×300×250 мм — 21 шт/м³, блок 600×300×250 мм — 22 шт/м³.',
  'сколько газоблоков в кубе': 'Количество блоков в кубе зависит от размера. Например: блок 625×300×250 мм — 21 шт/м³, блок 600×300×250 мм — 22 шт/м³, блок 625×200×250 мм — 32 шт/м³, перегородочный 600×100×250 мм — 67 шт/м³. Точное количество указано в карточке товара.',
  'газобетон производители': 'Топ производителей: Bonolit (широкая линейка, стабильная геометрия), Ytong/Istkult (эталон точности ±1 мм), ЛСР (отличное качество для северо-запада), Poritep (хорошее соотношение цена/качество). Региональные заводы (Коттедж, СГЗСБ, ГРАС) — выгодные цены и быстрая доставка.',
  'производители газобетона в спб': 'В Санкт-Петербурге и ЛО работают производители: ЛСР (отличное качество для влажного климата), Bonolit, Poritep. Также доступны региональные заводы с быстрой доставкой. В каталоге все бренды с описанием преимуществ и рекомендуемыми областями применения.',
  'минусы газобетона': 'Минусы: требует защиты от влаги (нужна отделка фасада), хрупкость при транспортировке (нужна аккуратная разгрузка), необходимость армирования. В целом для частного строительства плюсы значительно перевешивают минусы, особенно при правильном монтаже и отделке.',
  'минусы газоблока': 'Минусы: требует защиты от влаги (нужна отделка фасада), хрупкость при транспортировке (нужна аккуратная разгрузка), необходимость армирования. В целом для частного строительства плюсы значительно перевешивают минусы, особенно при правильном монтаже и отделке.',
  'газоблок плюсы': 'Плюсы: лёгкость (в 3–4 раза легче кирпича), отличная теплоизоляция, точная геометрия (±1–2 мм), скорость кладки, пожаробезопасность, экологичность, долговечность (50+ лет). Это оптимальный материал для частного строительства.',
  'газоблок плюсы и минусы': 'Плюсы: лёгкость, теплоизоляция, точная геометрия, скорость кладки, пожаробезопасность, экологичность, долговечность. Минусы: требует защиты от влаги, хрупкость при транспортировке, необходимость армирования. В целом для частного строительства плюсы значительно перевешивают минусы.',
  'пеноблок или газоблок': 'Газоблок (автоклавный) лучше: точная геометрия (±1–2 мм против ±5 мм у пеноблока), однородная структура, выше прочность и теплоизоляция, не даёт усадки, производится на крупных заводах с сертификацией. Для строительства дома рекомендуем газобетон.',
  'сколько газоблоков на дом': 'Для дома 10×10 м (100 м²) с толщиной стен 300 мм нужно примерно 650–750 блоков размером 625×300×250 мм (30–35 м³). Для точного расчёта используйте калькулятор: укажите периметр, высоту, толщину блоков — получите объём с запасом 5–7%.',
  'газобетон фундамент какой': 'Для газобетона подходят: плитный фундамент (УШП) — оптимальный вариант, ленточный фундамент — для стабильных грунтов, свайно-ростверковый — для сложных грунтов. Главное — обеспечить жёсткость и равномерную усадку. Консультируем по выбору фундамента под ваш проект.',
  'газобетон разница': 'Газобетон отличается от других материалов: легче кирпича в 3–4 раза, лучше сохраняет тепло, имеет точную геометрию (±1–2 мм), быстрее кладётся. В отличие от пенобетона производится в автоклаве, имеет стабильную геометрию и не даёт усадки.',
  'как сделать газобетон': 'Газобетон производится на заводах в автоклавах при высоком давлении и температуре. Для производства нужны: цемент, известь, песок, алюминиевая пудра, вода. Процесс сложный и требует специального оборудования, поэтому газобетон покупают готовым, а не делают самостоятельно.',
  'газобетон плюсы': 'Плюсы: лёгкость (в 3–4 раза легче кирпича), отличная теплоизоляция, точная геометрия (±1–2 мм), скорость кладки, пожаробезопасность, экологичность, долговечность (50+ лет). Это оптимальный материал для частного строительства.',
  'плиты из газобетона': 'Газобетонные плиты перекрытия используются для межэтажных перекрытий в малоэтажном строительстве. Они лёгкие, имеют хорошую теплоизоляцию и несущую способность. В нашем каталоге представлены блоки для стен и перегородок. Плиты перекрытия поставляются под заказ.',
  'монолитный газобетон': 'Монолитный газобетон — это технология заливки газобетонной смеси в опалубку на объекте. Мы работаем с автоклавным газобетоном — готовыми блоками заводского производства, которые имеют стабильную геометрию и сертификацию. Это более надёжный вариант для строительства.',
  // Популярные запросы из high_freq_low_comp.json
  'газобетонные блоки': 'Газобетонные блоки — популярный материал для строительства домов, бань и гаражей. В каталоге представлены блоки разных размеров и плотности от проверенных производителей. Каждый товар помечен назначением, указаны цены за м³ и наличие на складе.',
  'баня из газоблока': 'Газобетон отлично подходит для строительства бани. Блоки толщиной 200-300 мм обеспечивают хорошую теплоизоляцию, а паропроницаемость материала создаёт комфортный микроклимат. Для бани 6×4 м нужно примерно 6-8 м³ газобетона. Используйте калькулятор для точного расчёта.',
  'баня из газобетона': 'Газобетон отлично подходит для строительства бани. Блоки толщиной 200-300 мм обеспечивают хорошую теплоизоляцию. Для бани 6×4 м нужно примерно 6-8 м³ газобетона. Используйте калькулятор для точного расчёта или пришлите проект — рассчитаем количество блоков.',
  'газоблок размеры': 'В каталоге представлены блоки разных размеров: для наружных стен — 300-400 мм толщиной, для перегородок — 100-150 мм. Популярные размеры: 600×300×200 мм, 600×300×300 мм для стен, 600×100×200 мм для перегородок. Каждый размер указан в карточке товара.',
  'газобетон размеры': 'В каталоге представлены блоки разных размеров: для наружных стен — 300-400 мм толщиной, для перегородок — 100-150 мм. Популярные размеры указаны в карточке каждого товара с ценой за м³ и характеристиками. Используйте фильтры в каталоге для подбора нужного размера.',
  'стоимость газоблока за штуку в самаре': 'Цена за штуку зависит от размера блока и производителя. Например, блок 600×300×200 мм стоит от 180-250 рублей за штуку в зависимости от производителя. В каталоге указаны цены за м³ — это удобнее для расчёта объёма. Используйте калькулятор для точного расчёта.',
  'газобетонные блоки от производителя цена купить': 'В нашем каталоге представлены блоки от заводов-производителей с наличием на складе. Работаем напрямую с заводами, что позволяет предлагать выгодные цены и быструю доставку. Все блоки сертифицированы и соответствуют ГОСТ. Оставьте заявку в квизе или позвоните — подберём нужные блоки.',
  'калькулятор газобетона': 'Используйте наш калькулятор для точного расчёта количества газобетона: укажите периметр, высоту, толщину блоков, окна и двери — получите объём с запасом 5-7%. Или пришлите проект — инженер рассчитает вручную с учётом всех нюансов.',
  'калькулятор газоблока': 'Используйте наш калькулятор для точного расчёта количества газоблоков: укажите периметр, высоту, толщину блоков, окна и двери — получите объём с запасом 5-7%. Или пришлите проект — инженер рассчитает вручную с учётом всех нюансов.',
  'газоблоки в самаре цены': 'В каталоге указаны актуальные цены за м³ для Самары и Самарской области. Цена зависит от бренда, плотности и размера блока. При заказе от 30 м³ действует бесплатная доставка. Оставьте заявку в квизе или позвоните — подготовим КП с ценами.',
  'газоблок цена сгзсб': 'В каталоге представлены блоки СГЗСБ с актуальными ценами за м³. СГЗСБ — региональный производитель с выгодными ценами и быстрой доставкой по Самарской области. Все блоки сертифицированы. Оставьте заявку в квизе или позвоните — подберём нужные блоки.',
  'газобетон цена за куб': 'Цена за куб зависит от бренда, плотности, размера и региона. В каталоге указаны актуальные цены за м³ для каждого товара. Например, блоки D500 толщиной 300 мм стоят от 4500 до 6500 руб/м³. При заказе от 20-30 м³ — бесплатная доставка.',
  'перекрытие из газобетона': 'Газобетонные плиты перекрытия используются для межэтажных перекрытий в малоэтажном строительстве. Они лёгкие, имеют хорошую теплоизоляцию и несущую способность. В нашем каталоге представлены блоки для стен и перегородок. Плиты перекрытия поставляются под заказ — уточните у менеджера.',
  'газобетонные блоки bonolit': 'В каталоге представлены блоки Bonolit с наличием на складе. Bonolit — крупнейший производитель газобетона с широкой линейкой D400-D600 и стабильной геометрией. Все блоки сертифицированы и соответствуют ГОСТ. Оставьте заявку в квизе или позвоните — подберём нужные блоки.',
  'bonolit официальный сайт': 'Мы являемся официальным дилером Bonolit и работаем напрямую с заводом. В каталоге представлены блоки Bonolit с наличием на складе. Все блоки сертифицированы и соответствуют ГОСТ. Оставьте заявку в квизе или позвоните — подберём нужные блоки и подготовим КП.',
  'газобетон бонолит цена': 'Цена блоков Bonolit зависит от плотности и размера. В каталоге указаны актуальные цены за м³ для каждого товара. Bonolit — премиум-сегмент с гарантией качества. При заказе от 20 м³ — бесплатная доставка. Оставьте заявку в квизе — подготовим КП с ценами.',
  'газобетон istkult': 'В каталоге представлены блоки Istkult (Ytong) с наличием на складе. Istkult — эталон точности ±1 мм и высокая плотность структуры. Все блоки сертифицированы и соответствуют ГОСТ. Оставьте заявку в квизе или позвоните — подберём нужные блоки.',
  'газобетон цена за м3': 'Цена за м³ зависит от бренда, плотности, размера и региона. В каталоге указаны актуальные цены за м³ для каждого товара. При заказе от 20-30 м³ — бесплатная доставка. Оставьте заявку в квизе — подготовим КП с ценами.',
  'газобетонные блоки купить в спб от производителя': 'В нашем каталоге представлены блоки LSR, Bonolit, Ytong и других производителей с наличием на складе в Санкт-Петербурге. Работаем напрямую с заводами и региональными дилерами, что позволяет предлагать выгодные цены и быструю доставку. При заказе от 25 м³ — бесплатная доставка.',
  'газобетонные блоки размеры': 'В каталоге представлены блоки разных размеров: для наружных стен — 300-400 мм толщиной, для перегородок — 100-150 мм. Популярные размеры указаны в карточке каждого товара с ценой за м³ и характеристиками. Используйте фильтры в каталоге для подбора нужного размера.',
  'газобетон купить в спб от производителя d500': 'В каталоге представлены блоки D500 от производителей LSR, Bonolit, Ytong с наличием на складе в Санкт-Петербурге. Блоки D500 — универсальный выбор для несущих стен. Работаем напрямую с заводами. Оставьте заявку в квизе или позвоните — подберём нужные блоки.',
  'газобетон купить в спб цена за м3': 'В каталоге указаны актуальные цены за м³ для Санкт-Петербурга. Цена зависит от бренда и плотности. Блоки D500 толщиной 300 мм стоят от 5000 до 7000 руб/м³. При заказе от 25 м³ — бесплатная доставка по СПб и ЛО.',
  'производитель газобетонных блоков': 'В нашем каталоге представлены блоки от проверенных производителей: Bonolit, Ytong, LSR, Poritep, Коттедж, СГЗСБ и других. Работаем напрямую с заводами, что позволяет предлагать выгодные цены и быструю доставку. Все блоки сертифицированы.',
  'газобетон купить в уфе': 'В нашем каталоге представлены блоки разных производителей с актуальными ценами для Уфы и Башкортостана. Доставляем по всей территории республики. При заказе от 30 м³ — бесплатная доставка. Оставьте заявку в квизе или позвоните — подготовим КП с ценами.',
  'газоблок перегородочный': 'Перегородочные блоки имеют толщину 100-150 мм и плотность D400-D500. В каталоге представлены перегородочные блоки разных размеров с ценами за м³. Используйте фильтры в каталоге для подбора перегородочных блоков под ваш проект.',
};

/**
 * Получить топовые вопросы для региона из faq_topics.json и high_freq_low_comp.json
 */
export function getRegionalFAQQuestions(regionSlug: RegionSlug, limit: number = 5): FAQQuestion[] {
  const questions: FAQQuestion[] = [];
  const seenQueries = new Set<string>();

  // 1. Берём вопросы из faq_topics.json
  const regionData = (faqTopics as unknown as Record<string, [number, string, string][]>)[regionSlug];
  
  if (regionData) {
    const sorted = [...regionData]
      .sort((a, b) => b[0] - a[0])
      .slice(0, Math.ceil(limit * 0.6)); // 60% из faq_topics

    for (const [frequency, query, cluster] of sorted) {
      const queryLower = query.toLowerCase();
      if (!seenQueries.has(queryLower)) {
        const normalizedQuestion = normalizeQueryToQuestion(query);
        const answer = FAQ_ANSWERS[queryLower] || 
          `Ответ на вопрос зависит от конкретных условий вашего проекта. Оставьте заявку в квизе или позвоните нам — наши специалисты проконсультируют и помогут подобрать оптимальное решение.`;

        questions.push({
          q: normalizedQuestion,
          a: answer,
        });
        seenQueries.add(queryLower);
      }
    }
  }

  // 2. Добавляем вопросы из high_freq_low_comp.json (с умеренной конкуренцией)
  const highFreqData = (highFreqLowComp as Record<string, Array<{
    query: string;
    frequency: number;
    competition: string;
    intent: string;
    cluster: string;
  }>>)[regionSlug];

  if (highFreqData) {
    // Фильтруем по умеренной конкуренции и информационным/коммерческим запросам
    const filtered = highFreqData
      .filter(item => 
        item.competition === 'средняя' && 
        (item.intent === 'информационный' || item.intent === 'коммерческий') &&
        !seenQueries.has(item.query.toLowerCase())
      )
      .sort((a, b) => b.frequency - a.frequency)
      .slice(0, Math.ceil(limit * 0.4)); // 40% из high_freq_low_comp

    for (const item of filtered) {
      const queryLower = item.query.toLowerCase();
      if (!seenQueries.has(queryLower)) {
        // Преобразуем запрос в вопрос
        let normalizedQuestion = normalizeQueryToQuestion(item.query);
        
        // Если запрос уже в виде вопроса, используем его
        if (item.query.includes('?') || item.query.endsWith('?')) {
          normalizedQuestion = item.query.charAt(0).toUpperCase() + item.query.slice(1);
        }

        // Формируем ответ на основе типа запроса
        let answer = FAQ_ANSWERS[queryLower];
        
        if (!answer) {
          // Генерируем ответ на основе кластера и типа запроса
          if (item.cluster.includes('размеры') || item.cluster.includes('характеристики')) {
            answer = `В каталоге представлены блоки разных размеров: для наружных стен — 300-400 мм толщиной, для перегородок — 100-150 мм. Популярные размеры указаны в карточке каждого товара с ценой за м³ и характеристиками.`;
          } else if (item.cluster.includes('баня') || item.cluster.includes('проекты')) {
            answer = `Газобетон отлично подходит для строительства бани. Блоки толщиной 200-300 мм обеспечивают хорошую теплоизоляцию. Для бани 6×4 м нужно примерно 6-8 м³ газобетона. Используйте калькулятор для точного расчёта или пришлите проект.`;
          } else if (item.cluster.includes('цена') || item.cluster.includes('цены')) {
            answer = `Цена зависит от бренда, плотности, размера и региона. В каталоге указаны актуальные цены за м³ для каждого товара. При заказе от 20-30 м³ — бесплатная доставка. Оставьте заявку в квизе — подготовим КП с ценами.`;
          } else if (item.cluster.includes('производитель') || item.cluster.includes('бренд')) {
            answer = `В нашем каталоге представлены блоки от проверенных производителей с наличием на складе. Работаем напрямую с заводами, что позволяет предлагать выгодные цены и быструю доставку. Все блоки сертифицированы и соответствуют ГОСТ.`;
          } else {
            answer = `Ответ на этот вопрос зависит от конкретных условий вашего проекта. Оставьте заявку в квизе или позвоните нам — наши специалисты проконсультируют и помогут подобрать оптимальное решение.`;
          }
        }

        questions.push({
          q: normalizedQuestion,
          a: answer,
        });
        seenQueries.add(queryLower);
      }
    }
  }

  // Возвращаем топ вопросов (смешанные из обоих источников)
  return questions.slice(0, limit);
}

